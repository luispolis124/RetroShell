<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>RetroShell - Final Shield</title>
<script src="https://unpkg.com/jsnes/dist/jsnes.min.js"></script>

<style>
:root{
--nes-light:#d1d1d1;--nes-mid:#a3a3a3;--nes-dark:#353535;
--nes-red:#b5221b;--nes-black:#111;--shell-bg:#121212;
}
body{
background:var(--shell-bg);margin:0;min-height:100vh;
display:flex;align-items:center;justify-content:center;
font-family:sans-serif;overflow:hidden;
user-select:none;touch-action:none;
}
#main-layout{width:95vw;max-width:480px;display:flex;flex-direction:column;gap:15px}
#console-body{background:var(--nes-light);border-radius:12px;overflow:hidden;
box-shadow:8px 8px 0 #000;border:2px solid #555}
#console-top{display:flex}
#screen-area{flex:1;padding:12px}
#screen{background:#000;border:6px solid var(--nes-black);aspect-ratio:256/240}
canvas{width:100%;height:100%;image-rendering:pixelated}
.brand{display:flex;justify-content:space-between;font-weight:bold}
.brand-m{color:var(--nes-dark);font-size:14px}
.brand-s{color:var(--nes-red);font-size:8px}
#stripe-black{width:15%;background:var(--nes-dark);display:flex;flex-direction:column;gap:8px;align-items:center;justify-content:center}
.vents{width:60%;height:20px;background:repeating-linear-gradient(var(--nes-mid),var(--nes-mid)4px,var(--nes-light)4px,var(--nes-light)8px)}
#console-bottom{background:var(--nes-mid);height:45px;border-top:3px solid #888;
display:flex;align-items:center;gap:15px;padding:0 15px}
.power-led{width:8px;height:8px;background:#400;border-radius:50%}
.power-led.on{background:red;box-shadow:0 0 8px red}
#gamepad-container{position:relative;height:180px;background:#bbb;border:4px solid #888;border-radius:10px;box-shadow:0 6px 0 #444}
.dpad{position:absolute;left:15px;top:35px;
display:grid;grid-template-areas:". u ." "l . r" ". d .";gap:2px}
.btn-nes{width:45px;height:45px;background:#333;color:#777;border:none;border-radius:4px;font-size:20px}
.system-group{position:absolute;left:50%;bottom:25px;transform:translateX(-50%);display:flex;gap:15px}
.btn-pill{width:42px;height:14px;background:#555;border-radius:10px;border:2px solid #333}
.action-group{position:absolute;right:15px;top:50px;display:flex;gap:12px}
.btn-circle{width:55px;height:55px;background:var(--nes-red);border-radius:50%;border:3px solid #800;color:#fff;font-weight:bold;font-size:18px}
.label{font-size:9px;color:#333;font-weight:bold;text-transform:uppercase}
.unit{display:flex;flex-direction:column;align-items:center}
.c-btn-rect{width:32px;height:18px;background:#222;border:none;border-radius:2px}
</style>
</head>

<body>
<div id="main-layout">

<div id="console-body">
<div id="console-top">
<div id="screen-area">
<div class="brand"><span class="brand-m">RETROSHELL</span><span class="brand-s">NESCALL</span></div>
<div id="screen"><canvas id="nes-canvas" width="256" height="240"></canvas></div>
</div>
<div id="stripe-black"><div class="vents"></div><div class="vents"></div></div>
</div>

<div id="console-bottom">
<div class="power-led" id="led"></div>
<div class="unit">
<button class="c-btn-rect" onclick="romLoader.click()"></button>
<span class="label">Power</span>
</div>
<div class="unit">
<button class="c-btn-rect" onclick="nes.reloadROM()"></button>
<span class="label">Reset</span>
</div>
<input id="romLoader" type="file" accept=".nes" hidden>
</div>
</div>

<div id="gamepad-container">

<!-- D-PAD CORRETO -->
<div class="dpad">
<button class="btn-nes" style="grid-area:u" data-n="4">▲</button>
<button class="btn-nes" style="grid-area:l" data-n="6">◀</button>
<button class="btn-nes" style="grid-area:r" data-n="7">▶</button>
<button class="btn-nes" style="grid-area:d" data-n="5">▼</button>
</div>

<!-- SELECT / START -->
<div class="system-group">
<div class="unit"><button class="btn-pill" data-n="2"></button><span class="label">Select</span></div>
<div class="unit"><button class="btn-pill" data-n="3"></button><span class="label">Start</span></div>
</div>

<!-- A / B -->
<div class="action-group">
<div class="unit"><button class="btn-circle" data-n="1">B</button><span class="label">B</span></div>
<div class="unit"><button class="btn-circle" data-n="0">A</button><span class="label">A</span></div>
</div>

</div>
</div>

<script>
const canvas=document.getElementById("nes-canvas");
const ctx=canvas.getContext("2d",{alpha:false});
const imageData=ctx.getImageData(0,0,256,240);
const buf32=new Uint32Array(imageData.data.buffer);

let audioCtx=null,scriptNode=null;
let audioBuffer=new Float32Array(8192);
let writePtr=0,readPtr=0;

const nes=new jsnes.NES({
onFrame:fb=>{
for(let i=0;i<61440;i++)buf32[i]=0xFF000000|fb[i];
ctx.putImageData(imageData,0,0);
},
onAudioSample:(l,r)=>{
if(!audioCtx)return;
audioBuffer[writePtr]=l;
audioBuffer[writePtr+1]=r;
writePtr=(writePtr+2)%8192;
}
});

function loop(){
requestAnimationFrame(loop);
if(document.getElementById("led").classList.contains("on"))nes.frame();
}
loop();

romLoader.onchange=e=>{
const reader=new FileReader();
reader.onload=ev=>{
if(!audioCtx){
audioCtx=new AudioContext({sampleRate:44100});
scriptNode=audioCtx.createScriptProcessor(2048,0,2);
scriptNode.onaudioprocess=e=>{
const l=e.outputBuffer.getChannelData(0);
const r=e.outputBuffer.getChannelData(1);
for(let i=0;i<l.length;i++){
l[i]=audioBuffer[readPtr];
r[i]=audioBuffer[readPtr+1];
readPtr=(readPtr+2)%8192;
}
};
scriptNode.connect(audioCtx.destination);
}
nes.loadROM(ev.target.result);
document.getElementById("led").classList.add("on");
};
reader.readAsBinaryString(e.target.files[0]);
};

const handleInput=(id,down)=>{
down?nes.buttonDown(1,id):nes.buttonUp(1,id);
if(audioCtx&&audioCtx.state==="suspended")audioCtx.resume();
};

const isTouch=("ontouchstart"in window)||navigator.maxTouchPoints>0;

document.querySelectorAll("[data-n]").forEach(btn=>{
const id=Number(btn.dataset.n);
const press=e=>{e.preventDefault();handleInput(id,true)};
const release=e=>{e.preventDefault();handleInput(id,false)};

if(isTouch){
btn.addEventListener("touchstart",press,{passive:false});
btn.addEventListener("touchend",release,{passive:false});
btn.addEventListener("touchcancel",release,{passive:false});
}else{
btn.addEventListener("mousedown",press);
btn.addEventListener("mouseup",release);
btn.addEventListener("mouseleave",release);
}
});

const kMap={
90:0, // Z = A
88:1, // X = B
16:2, // Shift = Select
13:3, // Enter = Start
38:4, // ↑
40:5, // ↓
37:6, // ←
39:7  // →
};

onkeydown=e=>kMap[e.keyCode]!=null&&(e.preventDefault(),handleInput(kMap[e.keyCode],true));
onkeyup=e=>kMap[e.keyCode]!=null&&handleInput(kMap[e.keyCode],false);
</script>
</body>
</html>
